/*
 * ???????????????????????????????????????????????????????????????????????????????
 * ASP.NET CORE MÝDDLEWARE ÖRNEKLERÝ
 * ???????????????????????????????????????????????????????????????????????????????
 * 
 * MÝDDLEWARE NEDÝR?
 * ?????????????????
 * Middleware, HTTP isteklerini iþleyen yazýlým bileþenleridir.
 * Her middleware:
 *   1. Gelen isteði inceleyebilir veya deðiþtirebilir
 *   2. Bir sonraki middleware'e geçebilir veya isteði sonlandýrabilir
 *   3. Yanýt dönerken tekrar çalýþabilir
 * 
 * MÝDDLEWARE PÝPELINE (BORU HATTI) NASIL ÇALIÞIR?
 * ???????????????????????????????????????????????
 * 
 *     ÝSTEK (Request)
 *         ?
 *         ?
 *   ???????????????
 *   ? Middleware 1? ??? Loglama
 *   ???????????????
 *     ?
 * ?
 *   ???????????????
 *   ? Middleware 2? ??? Yetki Kontrolü
 *   ???????????????
 *?
 *         ?
 *   ???????????????
 *   ? Middleware 3? ??? Performans Ölçümü
 *   ???????????????
 *         ?
 *         ?
 *   ???????????????
 *   ? Controller  ? ??? Ýþ Mantýðý
 *   ???????????????
 *      ?
 * ?
 *     YANIT (Response)
 * 
 * 
 * ÖNEMLÝ: Middleware sýrasý çok önemlidir!
 * ??????????????????????????????????????
 * - Hata yakalayýcý EN BAÞTA olmalý (tüm hatalarý yakalasýn)
 * - Loglama erken olmalý (tüm istekleri loglasýn)
 * - Authentication, Routing'den önce olmalý
 * - Authorization, Authentication'dan sonra olmalý
 * 
 * ???????????????????????????????????????????????????????????????????????????????
 */

using _17_middleware2.Middlewares;

var builder = WebApplication.CreateBuilder(args);

// ???????????????????????????????????????????????????????????????????????????????
// SERVÝS KAYITLARI (Dependency Injection Container)
// ???????????????????????????????????????????????????????????????????????????????
// Bu bölümde uygulamanýn ihtiyaç duyduðu servisleri kaydediyoruz.
// DI (Dependency Injection) sayesinde bu servisler ihtiyaç duyulan yerlere
// otomatik olarak enjekte edilir.

builder.Services.AddControllersWithViews(); // MVC desteði

var app = builder.Build();

// ???????????????????????????????????????????????????????????????????????????????
// MÝDDLEWARE PÝPELINE YAPILANDIRMASI
// ???????????????????????????????????????????????????????????????????????????????
// Middleware'ler EKLEME SIRASINA GÖRE çalýþýr!
// Ýlk eklenen middleware, isteði ilk karþýlar.

/*
 * ???????????????????????????????????????????????????????????????????????????????
 * ? 1. HATA YAKALAYICI MÝDDLEWARE       ?
 * ?    ???????????????????????????? ?
 * ?    Neden en baþta? Çünkü sonraki TÜM middleware'lerdeki hatalarý    ?
 * ?    yakalayabilmesi için ilk sýrada olmalý.   ?
 * ?       ?
 * ?    Try-Catch bloðu gibi düþün: En dýþta olmalý ki her þeyi kapsasýn.       ?
 * ???????????????????????????????????????????????????????????????????????????????
 */
app.UseHataYakalayici();

/*
 * ???????????????????????????????????????????????????????????????????????????????
 * ? 2. LOGLAMA MÝDDLEWARE          ?
 * ?    ??????????????????     ?
 * ?    Tüm HTTP isteklerini ve yanýtlarýný loglar.     ?
 * ?    Debug ve monitoring için çok faydalý.              ?
 * ?           ?
 * ?    Loglar konsolda görünür (Visual Studio Output penceresinde).       ?
 * ???????????????????????????????????????????????????????????????????????????????
 */
app.UseLogging();

/*
 * ???????????????????????????????????????????????????????????????????????????????
 * ? 3. PERFORMANS ÖLÇÜM MÝDDLEWARE         ?
 * ?    ??????????????????????????   ?
 * ?    Her isteðin ne kadar sürdüðünü ölçer. ?
 * ?    Yavaþ istekleri tespit etmek için kullanýlýr. ?
 * ?           ?
 * ?    Response header'da "X-Islem-Suresi-Ms" olarak süreyi gösterir.      ?
 * ???????????????????????????????????????????????????????????????????????????????
 */
app.UsePerformans();

/*
 * ???????????????????????????????????????????????????????????????????????????????
 * ? 4. ÝSTEK LÝMÝT (RATE LIMITING) MÝDDLEWARE         ?
 * ?    ???????????????????????????????????????   ?
 * ?    Dakikada maksimum 60 istek izni verir.   ?
 * ?    Aþýrý istek yapan IP'leri engeller (DoS korumasý).     ?
 * ?  ?
 * ?    Response header'da kalan istek hakký gösterilir:            ?
 * ?    - X-RateLimit-Limit: Maksimum istek sayýsý             ?
 * ?- X-RateLimit-Remaining: Kalan istek hakký           ?
 * ???????????????????????????????????????????????????????????????????????????????
 */
app.UseIstekLimit();

/*
 * ???????????????????????????????????????????????????????????????????????????????
 * ? 5. YETKÝ KONTROL MÝDDLEWARE         ?
 * ?    ?????????????????????????                  ?
 * ?    /api/* ve /admin/* yollarý için API Key kontrolü yapar.         ?
 * ?    Header'da "X-Api-Key" olmalý ve deðeri appsettings.json'daki            ?
 * ?    deðerle eþleþmeli.  ?
 * ?     ?
 * ?    Test için: Postman veya curl ile X-Api-Key header'ý gönderin.           ?
 * ???????????????????????????????????????????????????????????????????????????????
 */
app.UseYetkiKontrol();

// ???????????????????????????????????????????????????????????????????????????????
// ASP.NET CORE'UN BUILT-IN MÝDDLEWARE'LERÝ
// ???????????????????????????????????????????????????????????????????????????????

// HTTPS yönlendirmesi - HTTP isteklerini HTTPS'e yönlendirir
app.UseHttpsRedirection();

// Statik dosyalar - wwwroot klasöründeki dosyalarý sunar (CSS, JS, resimler)
app.UseStaticFiles();

// Routing - URL'in hangi controller/action'a gideceðini belirler
app.UseRouting();

// Authorization - Yetkilendirme kontrolü (ASP.NET Core'un kendi sistemi)
app.UseAuthorization();

// ???????????????????????????????????????????????????????????????????????????????
// ENDPOINT YAPILANDIRMASI
// ???????????????????????????????????????????????????????????????????????????????

// Varsayýlan MVC route yapýlandýrmasý
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");

// ???????????????????????????????????????????????????????????????????????????????
// UYGULAMAYI BAÞLAT
// ???????????????????????????????????????????????????????????????????????????????
app.Run();


/*
 * ???????????????????????????????????????????????????????????????????????????????
 *      TEST SENARYOLARI
 * ???????????????????????????????????????????????????????????????????????????????
 * 
 * 1. LOGLAMA TESTÝ:
 *    - Herhangi bir sayfaya git
 *    - Visual Studio Output penceresinde loglarý gör
 * 
 * 2. PERFORMANS TESTÝ:
 *    - Tarayýcý DevTools > Network sekmesini aç
 *  - Bir istek yap
 *    - Response Headers'da "X-Islem-Suresi-Ms" deðerini kontrol et
 * 
 * 3. RATE LIMIT TESTÝ:
 *    - Sayfayý çok hýzlý bir þekilde 60'tan fazla yenile
 *    - "Çok Fazla Ýstek" sayfasýný göreceksin
 * 
 * 4. YETKÝ KONTROL TESTÝ:
 *    - /api/test adresine git (ApiController'da test action oluþtur)
 *    - 401 hatasý alacaksýn
 *    - Postman ile X-Api-Key: gizli-api-anahtari-12345 header'ý gönder
 *    - Baþarýlý yanýt alacaksýn
 * 
 * 5. HATA YAKALAMA TESTÝ:
 *    - /Home/HataTest adresine git (HomeController'da exception fýrlatan action)
 *    - Development modunda detaylý hata sayfasý göreceksin
 * 
 * ???????????????????????????????????????????????????????????????????????????????
 */
